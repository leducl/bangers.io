<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>NetParty 2D - Lobby</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { margin: 0; background: #121212; color: #eee; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* Containers */
        #ui-container { margin-top: 50px; width: 400px; position: relative; z-index: 10; }
        .panel { background: #1e1e1e; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 1px solid #333; display: none; }
        .panel.active { display: block; }
        
        /* Inputs & Buttons */
        h1, h2 { text-align: center; margin-top: 0; color: #e91e63; }
        input, select, button { width: 100%; box-sizing: border-box; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #444; background: #2a2a2a; color: white; font-size: 16px; }
        button { background: #e91e63; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { background: #c2185b; }
        button.secondary { background: #444; }
        button.secondary:hover { background: #555; }
        
        /* Room List */
        .room-item { background: #252525; padding: 10px; display: flex; justify-content: space-between; align-items: center; border-radius: 5px; margin-bottom: 5px; border-left: 4px solid #e91e63; }
        
        /* Errors */
        #error-msg { color: #ff5252; text-align: center; margin-bottom: 10px; font-size: 14px; min-height: 20px;}
    </style>
</head>
<body>

    <div id="ui-container">
        
        <div id="panel-menu" class="panel active">
            <h1>Bangers.io</h1>
            <div id="error-msg"></div>
            
            <label>Ton Pseudo</label>
            <input type="text" id="username" placeholder="Pseudo" maxlength="10">
            
            <label>Ta Couleur</label>
            <input type="color" id="usercolor" value="#00ff00" style="height: 50px; padding: 2px;">

            <hr style="border-color: #333; margin: 20px 0;">
            
            <button onclick="goToCreate()">CR√âER UN SALON</button>
            <button onclick="goToJoinList()">LISTE DES SALONS</button>
            <button onclick="goToJoinCode()" class="secondary">REJOINDRE VIA CODE</button>
        </div>

        <script src="items.js"></script> 

        <div id="panel-create" class="panel">
            <h2>Cr√©er un Salon</h2>
            
            <div style="text-align:center; margin-bottom:10px;">
                <canvas id="create-map-preview" width="300" height="225" style="background:#000; border:2px solid #555; border-radius:4px;"></canvas>
            </div>

            <label>Choisir la Carte :</label>
            <select id="create-map" onchange="updateMapPreview()"><option>Chargement...</option></select>            
            <label>Visibilit√© :</label>
            <select id="create-public">
                <option value="true">Public (Visible)</option>
                <option value="false">Priv√© (Cach√©)</option>
            </select>
            
            <button onclick="toggleAdvanced()" class="secondary" style="margin: 15px 0; background:#444; border:1px solid #666;">
                ‚öôÔ∏è Param√®tres de la partie...
            </button>

            <div id="advanced-options" style="display:none; background:#222; padding:15px; border-radius:8px; border:1px solid #444; margin-bottom:15px;">
                <h3 style="margin-top:0; font-size:16px; color:#aaa; border-bottom:1px solid #444; padding-bottom:5px;">R√®gles</h3>
                
                <label>Points pour gagner :</label>
                <input type="number" id="create-score" value="20" min="5" max="100">

                <label>Temps de la manche (secondes) :</label>
                <input type="number" id="create-time" value="45" min="10" max="300">

                <label>Mode de jeu :</label>
                <select id="create-mode">
                    <option value="respawn">Classique (Respawn infini)</option>
                    <option value="perma">Mort Subite (1 seule vie)</option>
                </select>

                <h3 style="margin-top:15px; font-size:16px; color:#aaa; border-bottom:1px solid #444; padding-bottom:5px;">Objets Autoris√©s</h3>
                
                <div id="create-items-container" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap:10px; margin-top:10px;">
                    </div>
            </div>
            
            <input type="password" id="create-pass" placeholder="Mot de passe (Laisser vide pour aucun)">

            <button onclick="doCreateRoom()">VALIDER ET CR√âER</button>
            <button onclick="showPanel('panel-menu')" class="secondary">RETOUR</button>
        </div>

        <div id="panel-list" class="panel">
            <h2>Salons Publics</h2>
            <div id="room-list-container">Chargement...</div>
            <button onclick="showPanel('panel-menu')" class="secondary">RETOUR</button>
        </div>

        <div id="panel-code" class="panel">
            <h2>Rejoindre</h2>
            <input type="text" id="join-code-input" placeholder="Entrer le Code du Salon (ex: ABCDE)" style="text-transform:uppercase">
            <input type="password" id="join-pass-input" placeholder="Mot de passe (Si n√©cessaire)">
            <button onclick="doJoinByCode()">REJOINDRE</button>
            <button onclick="showPanel('panel-menu')" class="secondary">RETOUR</button>
        </div>

        <div id="panel-lobby" class="panel">
            <h2 id="lobby-code">CODE: ----</h2>

            <h3 id="lobby-map-name" style="text-align:center; color:#e91e63; margin:5px 0;">Map: ...</h3>
            <div style="text-align:center;">
                <canvas id="lobby-map-preview" width="300" height="225" style="background:#000; border:1px solid #444;"></canvas>
            </div>

            <p style="text-align:center; color:#aaa">En attente de l'h√¥te...</p>
            <div id="player-list" style="margin: 20px 0; background:#111; padding:10px; border-radius:5px;"></div>
            
            <button id="btn-start" onclick="doStartGame()" style="display:none">LANCER LA PARTIE</button>
            <button onclick="location.reload()" class="secondary">QUITTER</button>
        </div>
    </div>

    <script>
        // Initialisation Socket
        const socket = io();
        let availableMaps = []; // On stockera la liste compl√®te re√ßue du serveur

        // --- SAUVEGARDE ET CHARGEMENT LOCALE ---
        window.addEventListener('load', () => {
            const savedName = localStorage.getItem('np_username');
            const savedColor = localStorage.getItem('np_usercolor');

            if(savedName) document.getElementById('username').value = savedName;
            if(savedColor) document.getElementById('usercolor').value = savedColor;
        });

        function renderMapOnCanvas(canvasId, mapItems) {
            const canvas = document.getElementById(canvasId);
            if (!canvas || !mapItems) return;
            
            const ctx = canvas.getContext('2d');
            const W = 800; // Largeur r√©elle du jeu
            const H = 600; // Hauteur r√©elle du jeu
            
            // Calcul du ratio pour adapter 800x600 √† la taille du canvas (300x225)
            const scaleX = canvas.width / W;
            const scaleY = canvas.height / H;

            // Effacer
            ctx.fillStyle = '#222';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Dessiner chaque objet
            mapItems.forEach(item => {
                const def = ITEM_REGISTRY[item.type];
                if (def) {
                    // Couleur de l'objet (fallback si pas d'image, ou code couleur d√©fini)
                    // On utilise la propri√©t√© .color de items.js
                    let colorHex = '#888888';
                    if (def.color) colorHex = '#' + def.color.toString(16).padStart(6, '0');
                    
                    // Cas sp√©ciaux pour rendre la map lisible
                    if (item.type === 90) colorHex = '#0000FF'; // D√©part Bleu
                    if (item.type === 91) colorHex = '#FFD700'; // Arriv√©e Or
                    if (def.isSolid) ctx.globalAlpha = 1;
                    else ctx.globalAlpha = 0.6; // Les pi√®ges un peu transparents

                    ctx.fillStyle = colorHex;
                    
                    // Dessin du rectangle √† l'√©chelle
                    // item.x et item.y sont les coins haut-gauche
                    ctx.fillRect(item.x * scaleX, item.y * scaleY, 32 * scaleX, 32 * scaleY);
                }
            });
            ctx.globalAlpha = 1;
        }

        // --- NAVIGATION UI ---


        // R√©ception de la liste des maps (avec les DATA maintenant)
        socket.on('mapListUpdate', (maps) => {
            availableMaps = maps; // On sauvegarde
            const select = document.getElementById('create-map');
            select.innerHTML = "";
            
            maps.forEach(m => {
                select.innerHTML += `<option value="${m.id}">${m.name}</option>`;
            });

            // Forcer l'affichage de la premi√®re map par d√©faut
            updateMapPreview();
        });

        // Appel√©e quand on change le select HTML
        function updateMapPreview() {
            const select = document.getElementById('create-map');
            const mapId = select.value;
            const mapObj = availableMaps.find(m => m.id === mapId);
            
            if (mapObj) {
                renderMapOnCanvas('create-map-preview', mapObj.data);
            }
        }

        function showPanel(id) {
            document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('error-msg').innerText = "";
        }

        function getUserInfo() {
            const name = document.getElementById('username').value || "Joueur" + Math.floor(Math.random()*1000);
            const colorRaw = document.getElementById('usercolor').value;
            const color = parseInt(colorRaw.replace('#', '0x'));
            
            // SAUVEGARDE
            localStorage.setItem('np_username', name);
            localStorage.setItem('np_usercolor', colorRaw);
            
            return { name, color };
        }

        function goToCreate() { 
            showPanel('panel-create'); 
            // Demander la liste des cartes au serveur quand on ouvre ce menu
            socket.emit('requestMapList');
            initCreateUI(); 
        } 

        socket.on('mapListUpdate', (maps) => {
            const select = document.getElementById('create-map');
            select.innerHTML = "";
            maps.forEach(m => {
                select.innerHTML += `<option value="${m.id}">${m.name}</option>`;
            });
        });

        function goToJoinCode() { showPanel('panel-code'); }
        function goToJoinList() { 
            showPanel('panel-list'); 
            socket.emit('requestRoomList');
        }

        // --- ACTIONS SOCKET ---

        function toggleAdvanced() {
            const el = document.getElementById('advanced-options');
            if (el.style.display === 'none') {
                el.style.display = 'block';
            } else {
                el.style.display = 'none';
            }
        }

        function initCreateUI() {
            const container = document.getElementById('create-items-container');
            container.innerHTML = "";

            Object.values(ITEM_REGISTRY).forEach(item => {
                if (!item.isSystem) {
                    const checked = "checked";
                    
                    // On pr√©pare l'image ou un carr√© de couleur si pas d'image
                    let visual = "";
                    if (item.image) {
                        // Assure-toi que les images sont bien dans un dossier 'assets/' accessible
                        visual = `<img src="assets/${item.image}" style="width:24px; height:24px; object-fit:contain; margin-right:8px;">`;
                    } else {
                        const colorHex = '#' + item.color.toString(16).padStart(6, '0');
                        visual = `<div style="width:24px; height:24px; background:${colorHex}; margin-right:8px; border-radius:4px; border:1px solid #555;"></div>`;
                    }

                    // On cr√©e une belle √©tiquette cliquable
                    container.innerHTML += `
                        <label style="
                            background:#333; 
                            padding:8px; 
                            border-radius:6px; 
                            font-size:13px; 
                            display:flex; 
                            align-items:center; 
                            cursor:pointer; 
                            border:1px solid #444; 
                            user-select:none;
                            transition:0.2s;
                        " onmouseover="this.style.background='#444'" onmouseout="this.style.background='#333'">
                            
                            <input type="checkbox" id="item-chk-${item.id}" value="${item.id}" ${checked} style="width:auto; margin:0 8px 0 0;">
                            ${visual}
                            <span>${item.name}</span>
                        </label>`;
                }
            });
        }


        // Cr√©er
        function doCreateRoom() {
            const info = getUserInfo();
            
            // 1. R√©cup√©rer les items coch√©s
            const allowedItems = [];
            document.querySelectorAll('#create-items-container input[type="checkbox"]').forEach(chk => {
                if(chk.checked) allowedItems.push(parseInt(chk.value));
            });

            // 2. Construire la config compl√®te
            const config = {
                name: info.name,
                color: info.color,
                password: document.getElementById('create-pass').value,
                isPublic: document.getElementById('create-public').value === "true",
                mapId: document.getElementById('create-map').value,
                maxScore: parseInt(document.getElementById('create-score').value) || 20,
                // Nouveaux param√®tres
                runTime: parseInt(document.getElementById('create-time').value) || 45,
                gameMode: document.getElementById('create-mode').value, // 'respawn' ou 'perma'
                allowedItems: allowedItems
            };

            if (allowedItems.length < 1) return alert("Il faut au moins 1 objet !");

            socket.emit('createRoom', config);
        }

        // Rejoindre via la liste
        function joinFromList(code, hasPass) {
            const info = getUserInfo();
            let pass = "";
            if(hasPass) pass = prompt("Ce salon est prot√©g√©. Mot de passe ?");
            
            socket.emit('joinRoom', { code, password: pass, name: info.name, color: info.color });
        }

        // Rejoindre via code manuel
        function doJoinByCode() {
            const info = getUserInfo();
            const code = document.getElementById('join-code-input').value.toUpperCase().trim();
            const pass = document.getElementById('join-pass-input').value;

            if(code.length < 5) return alert("Code invalide");

            socket.emit('joinRoom', { code, password: pass, name: info.name, color: info.color });
        }

        // Lancer la partie
        function doStartGame() {
            const codeText = document.getElementById('lobby-code').innerText.split(' ')[1];
            socket.emit('startGame', codeText);
        }

        // --- √âCOUTEURS SOCKET ---

        socket.on('errorMsg', (msg) => {
            alert(msg);
        });

        socket.on('roomListUpdate', (rooms) => {
            const container = document.getElementById('room-list-container');
            container.innerHTML = "";
            if(rooms.length === 0) container.innerHTML = "<p>Aucun salon public.</p>";
            
            rooms.forEach(r => {
                container.innerHTML += `
                    <div class="room-item">
                        <span><b>${r.code}</b> (${r.count}/${r.max}) ${r.hasPass ? 'üîí' : ''}</span>
                        <button style="width:auto; padding:5px 15px; font-size:12px" 
                            onclick="joinFromList('${r.code}', ${r.hasPass})">GO</button>
                    </div>`;
            });
        });

        socket.on('roomJoined', (data) => {
            showPanel('panel-lobby');
            document.getElementById('lobby-code').innerText = `CODE: ${data.code}`;

            // Affichage Info Map
            if (data.mapName && data.mapData) {
                document.getElementById('lobby-map-name').innerText = `Carte : ${data.mapName}`;
                renderMapOnCanvas('lobby-map-preview', data.mapData);
            }

            // On d√©l√®gue l'affichage √† updatePlayers
            updateLobbyUI(data.players);
        });

        socket.on('updatePlayers', (players) => {
            updateLobbyUI(players);
        });

        function updateLobbyUI(players) {
            const list = document.getElementById('player-list');
            list.innerHTML = "";
            
            // R√©cup√©rer mon nom local pour v√©rifier si je suis l'h√¥te
            const myName = localStorage.getItem('np_username');
            let amIHost = false;

            Object.values(players).forEach(p => {
                const colorHex = '#' + p.color.toString(16).padStart(6, '0');
                
                // Si ce joueur correspond √† mon nom ET qu'il est host
                if(p.name === myName && p.isHost) {
                    amIHost = true;
                }

                list.innerHTML += `<div style="color:${colorHex}; margin:5px">
                    ${p.isHost ? 'üëë' : 'üë§'} ${p.name}
                </div>`;
            });

            // Bouton Start visible seulement si je suis l'host
            document.getElementById('btn-start').style.display = amIHost ? 'block' : 'none';
        }

        // --- REDIRECTION VERS LE JEU ---
        socket.on('redirectGame', (data) => {
            console.log("Lancement de la partie, redirection vers :", data.url);
            window.location.href = data.url;
        });

    </script>
</body>
</html>