<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>NetParty Hub - Bangers.io</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="items.js"></script> 
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="ui-container">
        
        <div id="login-panel" class="panel active">
            <h1>NETPARTY HUB</h1>
            <input type="text" id="username" placeholder="Ton Pseudo" maxlength="12">
            <input type="color" id="usercolor" value="#00ff00" style="height:40px;">
            <button onclick="doLogin()">ENTRER</button>
        </div>

        <div id="lobby-menu" class="panel">
            <h2 id="welcome-msg"></h2>
            <button onclick="showPanel('create-room-panel')">CR√âER UNE SALLE</button>
            <button onclick="refreshRooms()" class="secondary">ACTUALISER</button>
            <div id="room-list" style="margin-top:20px; max-height:300px; overflow-y:auto;"></div>
        </div>

        <div id="create-room-panel" class="panel">
            <h2>NOUVELLE SALLE</h2>
            <input type="text" id="room-config-name" placeholder="Nom de la salle" value="Salle de Jeux">
            <button onclick="doCreateRoom()">CR√âER</button>
            <button onclick="showPanel('lobby-menu')" class="secondary">RETOUR</button>
        </div>

        <div id="room-lobby-panel" class="panel" style="width: 100%; box-sizing: border-box;">
            <div class="lobby-grid">
                
                <div class="lobby-column">
                    <h2 id="lobby-title" style="text-align:left; margin:0">SALON</h2>
                    <div id="lobby-code-display" style="color:#888; font-family:monospace; margin-bottom:10px;">CODE: ???</div>
                    
                    <div style="background:#222; padding:10px; border-radius:5px;">
                        <h4 style="margin:0 0 10px 0; color:#aaa;">JOUEURS</h4>
                        <div id="player-list"></div>
                    </div>

                    <div id="host-settings" style="display:none;">
                        <h4 style="margin:10px 0 5px 0; color:#e91e63;">PARAM√àTRES DE LA PARTIE</h4>

                        <label>JEU √Ä LANCER</label>
                        <select id="game-select" onchange="toggleGameUI()" style="width:100%; padding:5px; margin-bottom:15px;">
                            <option value="bangers">Bangers.io (Plateforme)</option>
                            <option value="liars">Liar's Bar (Cartes/Bluff)</option>
                        </select>

                        <div id="options-bangers">
                            <label>CARTE</label>
                            <select id="map-select" onchange="updateSettings()"></select>

                            <div class="setting-row">
                                <div style="flex:1">
                                    <label>SCORE MAX</label>
                                    <input type="number" id="score-input" value="15" min="5" max="100" onchange="updateSettings()">
                                </div>
                                <div style="flex:1">
                                    <label>TEMPS (Sec)</label>
                                    <input type="number" id="time-input" value="45" min="15" max="120" onchange="updateSettings()">
                                </div>
                            </div>

                            <label>MODE DE JEU</label>
                            <select id="mode-select" onchange="updateSettings()">
                                <option value="respawn">Infini (Respawn)</option>
                                <option value="perma">Survie (Mort Subite)</option>
                            </select>

                            <label>OBJETS AUTORIS√âS</label>
                            <div class="item-grid" id="host-item-selector"></div>
                        </div>

                        <div id="options-liars" style="display:none;">
                            <label>TAILLE DU DECK</label>
                            <select id="liars-deck-size">
                                <option value="20">20 Cartes (Rapide)</option>
                                <option value="52">52 Cartes (Complet)</option>
                            </select>
                            <p style="font-size:12px; color:#aaa; margin-top:5px;">
                                Bluffez vos amis et soyez le dernier survivant √† la table.
                            </p>
                        </div>

                        <button onclick="doLaunchGame()" style="margin-top:15px; background:#4caf50; width:100%;">LANCER LA PARTIE</button>
                    </div>

                    <div id="waiting-msg" style="text-align:center; color:#aaa; margin-top:20px;">
                        En attente de l'h√¥te...
                    </div>
                    <button onclick="doLeaveRoom()" class="secondary">QUITTER LE SALON</button>
                </div>

                <div class="lobby-column">
                    <div id="preview-panel">
                        <h3 style="color:white; margin-top:0;">R√âGLAGES ACTUELS</h3>
                        
                        <canvas id="map-canvas" width="240" height="180"></canvas>
                        <div id="preview-map-name" style="font-weight:bold; color:#e91e63; margin-bottom:10px;">Chargement...</div>

                        <div style="text-align:left; font-size:14px; color:#ccc;">
                            <div style="margin-bottom:5px;">üèÅ Score: <span id="disp-score" style="color:white; font-weight:bold;">-</span></div>
                            <div style="margin-bottom:5px;">‚è± Temps: <span id="disp-time" style="color:white; font-weight:bold;">-</span></div>
                            <div style="margin-bottom:10px;">üíÄ Mode: <span id="disp-mode" style="color:#e91e63; font-weight:bold;">-</span></div>
                            
                            <label>OBJETS DISPONIBLES :</label>
                            <div id="preview-items-list" class="preview-items">
                                </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script>
        const socket = io();
        let myName = localStorage.getItem('np_username') || "";
        let myColor = localStorage.getItem('np_usercolor') || "#00ff00";
        let isHost = false;
        let selectedItems = []; // IDs des items s√©lectionn√©s par l'h√¥te
        let pendingMapId = null;

        // --- INIT & NAVIGATION ---
        if(myName) document.getElementById('username').value = myName;
        document.getElementById('usercolor').value = myColor;

        function showPanel(id) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function doLogin() {
            myName = document.getElementById('username').value.trim();
            myColor = document.getElementById('usercolor').value;
            if(!myName) return alert("Pseudo requis");
            localStorage.setItem('np_username', myName);
            localStorage.setItem('np_usercolor', myColor);
            showPanel('lobby-menu');
            refreshRooms();
        }

        function refreshRooms() { socket.emit('requestRoomList'); }
        socket.on('roomListUpdate', (rooms) => {
            const list = document.getElementById('room-list');
            list.innerHTML = rooms.length ? "" : "<div style='text-align:center; color:#555'>Aucune salle.</div>";
            rooms.forEach(r => {
                list.innerHTML += `<div class="player-item"><span>${r.hasPass?'üîí':''} Salle #${r.code} (${r.count}/${r.max})</span> <button style="width:auto; padding:5px 10px;" onclick="joinRoom('${r.code}', ${r.hasPass})">GO</button></div>`;
            });
        });

        // Change l'interface selon le jeu choisi
        function toggleGameUI() {
            const game = document.getElementById('game-select').value;

            if (game === 'bangers') {
                document.getElementById('options-bangers').style.display = 'block';
                document.getElementById('options-liars').style.display = 'none';
                document.getElementById('preview-panel').style.visibility = 'visible';
            } else {
                document.getElementById('options-bangers').style.display = 'none';
                document.getElementById('options-liars').style.display = 'block';
                document.getElementById('preview-panel').style.visibility = 'hidden';
            }

            // IMPORTANT : On sauvegarde le changement de jeu sur le serveur imm√©diatement
            if(isHost) updateSettings(); 
        }

        function doCreateRoom() {
            socket.emit('createRoom', { name: myName, color: myColor, roomName: document.getElementById('room-config-name').value, isPublic: true });
        }
        function joinRoom(code, hasPass) {
            socket.emit('joinRoom', { code, name: myName, color: myColor }); // Simplifi√© sans mot de passe pour l'exemple
        }
        function doLeaveRoom() { location.reload(); }

        // --- LOGIQUE LOBBY ---

        socket.on('roomJoined', (data) => {
            showPanel('room-lobby-panel');
            document.getElementById('lobby-code-display').innerText = `CODE: ${data.code}`;
            isHost = data.isHost;
            updateLobbyUI(data.players);
    
            if (isHost) {
                socket.emit('requestMapList');
                initHostItemSelector();
                // Force l'envoi de la config par d√©faut si c'est une nouvelle salle
                updateSettings(); 
            } else {
                socket.emit('requestLobbyInfo');
            }
        });

        socket.on('updatePlayers', (players) => {
            const me = Object.values(players).find(p => p.name === myName);
            if(me) isHost = me.isHost;
            updateLobbyUI(players);
        });

        // --- GESTION DU CHANGEMENT D'H√îTE ---
        socket.on('youAreHost', (currentConfig) => {
            isHost = true;
            alert("L'h√¥te est parti. Tu es le nouveau chef !");

            // 1. On affiche le panneau de r√©glages
            document.getElementById('host-settings').style.display = 'block';
            document.getElementById('waiting-msg').style.display = 'none';

            // 2. IMPORTANT : On met √† jour les INPUTS avec la config du serveur
            // Sinon, les inputs gardent leurs valeurs par d√©faut (ex: 15pts) et √©crasent tout
            if (currentConfig) {
                // --- AJOUT : Restauration du jeu s√©lectionn√© ---
                if (currentConfig.gameId) {
                    document.getElementById('game-select').value = currentConfig.gameId;
                    // On force l'UI √† s'adapter (mais attention √† updateSettings qui est dans toggleGameUI)
                    // Ici on veut juste changer l'affichage visuel :
                    const game = currentConfig.gameId;
                     if (game === 'bangers') {
                        document.getElementById('options-bangers').style.display = 'block';
                        document.getElementById('options-liars').style.display = 'none';
                        document.getElementById('preview-panel').style.visibility = 'visible';
                    } else {
                        document.getElementById('options-bangers').style.display = 'none';
                        document.getElementById('options-liars').style.display = 'block';
                        document.getElementById('preview-panel').style.visibility = 'hidden';
                    }
                }
                if (currentConfig.maxScore) document.getElementById('score-input').value = currentConfig.maxScore;
                if (currentConfig.runTime) document.getElementById('time-input').value = currentConfig.runTime;
                if (currentConfig.gameMode) document.getElementById('mode-select').value = currentConfig.gameMode;
                
                // On met √† jour la liste locale des items s√©lectionn√©s
                if (currentConfig.allowedItems) {
                    selectedItems = [...currentConfig.allowedItems];
                }
                if (currentConfig.mapId) {
                    pendingMapId = currentConfig.mapId;
                }
            }

            // 3. On demande la liste des cartes (car l'invit√© ne l'avait pas)
            socket.emit('requestMapList');

            // 4. On initialise le s√©lecteur d'objets
            initHostItemSelector();
        });

        function updateLobbyUI(players) {
            const list = document.getElementById('player-list');
            list.innerHTML = "";
            Object.values(players).forEach(p => {
                list.innerHTML += `<div class="player-item"><span style="color:${typeof p.color === 'number' ? '#' + p.color.toString(16).padStart(6,'0') : p.color}">${p.isHost?'üëë ':''}${p.name}</span></div>`;
            });

            document.getElementById('host-settings').style.display = isHost ? 'block' : 'none';
            document.getElementById('waiting-msg').style.display = isHost ? 'none' : 'block';
        }

        socket.on('mapListUpdate', (maps) => {
            const select = document.getElementById('map-select');
            select.innerHTML = "";
            maps.forEach(m => {
                select.innerHTML += `<option value="${m.id}">${m.name}</option>`;
            });
            if (pendingMapId) {
                select.value = pendingMapId; 
                pendingMapId = null; // On vide la variable pour ne pas interf√©rer plus tard
            }
            // Initial trigger pour envoyer la configuration par d√©faut
            updateSettings();
        });

        // --- GESTION DES REGLAGES (Client-Side) ---

        // 1. Initialiser la grille d'items (H√¥te seulement)
        function initHostItemSelector() {
            const container = document.getElementById('host-item-selector');
            container.innerHTML = "";
            
            // SI selectedItems est vide (premier lancement), on coche tout par d√©faut.
            // SI on vient de r√©cup√©rer le lead (host migration), selectedItems contient d√©j√† la config du serveur.
            const isFirstInit = (selectedItems.length === 0);

            Object.keys(ITEM_REGISTRY).forEach(id => {
                const item = ITEM_REGISTRY[id];
                if(item.isSystem) return;

                const itemId = parseInt(id);

                // Logique de pr√©s√©lection
                if (isFirstInit) {
                    selectedItems.push(itemId); 
                }
                
                // Est-ce que cet item est dans la liste active ?
                const isActive = selectedItems.includes(itemId);

                const div = document.createElement('div');
                div.className = isActive ? 'item-option selected' : 'item-option';
                div.title = item.name;
                
                if(item.image) div.innerHTML = `<img src="assets/${item.image}">`;
                else div.style.backgroundColor = '#' + item.color.toString(16).padStart(6,'0');

                div.onclick = () => {
                    const idx = selectedItems.indexOf(itemId);
                    if(idx > -1) {
                        selectedItems.splice(idx, 1);
                        div.classList.remove('selected');
                    } else {
                        selectedItems.push(itemId);
                        div.classList.add('selected');
                    }
                    updateSettings();
                };
                container.appendChild(div);
            });
        }


        window.updateSettings = function() {
            if(!isHost) return;
            
            const config = {
                // AJOUT : On envoie quel jeu est choisi
                gameId: document.getElementById('game-select').value, 
                
                // Le reste ne change pas
                mapId: document.getElementById('map-select').value,
                maxScore: document.getElementById('score-input').value,
                runTime: document.getElementById('time-input').value,
                gameMode: document.getElementById('mode-select').value,
                allowedItems: selectedItems,
                
                // Pour Liar's Bar
                liarsDeckSize: document.getElementById('liars-deck-size').value
            };
            socket.emit('updateLobbySettings', config);
        }

        // 3. Recevoir les mises √† jour (Tout le monde)
        socket.on('lobbySettingsUpdate', (data) => {
            const cfg = data.config;
            
            const currentSelect = document.getElementById('game-select');
            if (cfg.gameId && currentSelect.value !== cfg.gameId) {
                currentSelect.value = cfg.gameId;
                // On change l'UI visuelle sans renvoyer de donn√©es au serveur (pour √©viter une boucle infinie)
                const game = cfg.gameId;
                if (game === 'bangers') {
                    document.getElementById('options-bangers').style.display = 'block';
                    document.getElementById('options-liars').style.display = 'none';
                    document.getElementById('preview-panel').style.visibility = 'visible';
                } else {
                    document.getElementById('options-bangers').style.display = 'none';
                    document.getElementById('options-liars').style.display = 'block';
                    document.getElementById('preview-panel').style.visibility = 'hidden';
                }
            }

            // Mise √† jour textes droite
            document.getElementById('disp-score').innerText = cfg.maxScore || 20;
            document.getElementById('disp-time').innerText = (cfg.runTime || 45) + 's';
            document.getElementById('disp-mode').innerText = (cfg.gameMode === 'perma') ? "SURVIE" : "INFINI";
            
            if(cfg.liarsDeckSize) document.getElementById('liars-deck-size').value = cfg.liarsDeckSize;

            // Mise √† jour liste items visuelle
            const itemCont = document.getElementById('preview-items-list');
            itemCont.innerHTML = "";
            if(cfg.allowedItems && cfg.allowedItems.length > 0) {
                cfg.allowedItems.forEach(id => {
                    const item = ITEM_REGISTRY[id];
                    if(item) {
                        if(item.image) itemCont.innerHTML += `<img src="assets/${item.image}" title="${item.name}">`;
                        else itemCont.innerHTML += `<div style="display:inline-block;width:10px;height:10px;background:#${item.color.toString(16)};margin:2px;"></div>`;
                    }
                });
            } else {
                itemCont.innerText = "Aucun objet !";
            }

            // Mise √† jour Canvas
            if (data.mapPreview) {
                drawMapPreview(data.mapPreview);
                const mapSelect = document.getElementById('map-select');
                // Astuce pour r√©cup√©rer le nom si on a la liste, sinon ID
                const name = mapSelect.options[mapSelect.selectedIndex]?.text || cfg.mapId;
                document.getElementById('preview-map-name').innerText = name || "Carte";
            }
        });

        // --- CANVAS DESSIN ---
        function drawMapPreview(mapData) {
            const cvs = document.getElementById('map-canvas');
            const ctx = cvs.getContext('2d');
            
            // Effacer (fond noir)
            ctx.fillStyle = "#111";
            ctx.fillRect(0, 0, cvs.width, cvs.height);

            if(!mapData) return;

            // Calcul de l'√©chelle pour tout faire tenir dans 240x180
            // Supposons map standard 800x600 -> scale = 0.3
            const scaleX = cvs.width / 800;
            const scaleY = cvs.height / 600;
            const scale = Math.min(scaleX, scaleY);

            mapData.forEach(obj => {
                const def = ITEM_REGISTRY[obj.type];
                if(!def) return;

                // Position ajust√©e
                const x = obj.x * scale;
                const y = obj.y * scale;
                const s = 32 * scale; // Taille bloc standard 32px

                // Couleur ou Dessin simple
                if(def.color) {
                    ctx.fillStyle = '#' + def.color.toString(16).padStart(6,'0');
                } else {
                    ctx.fillStyle = '#666';
                }

                if(obj.type == 90) ctx.fillStyle = "#0000ff"; // D√©part
                if(obj.type == 91) ctx.fillStyle = "#ffd700"; // Arriv√©e

                // On dessine un carr√©
                ctx.fillRect(x, y, s, s);
            });
        }

        function doLaunchGame() {
            const selectedGame = document.getElementById('game-select').value;
            let options = {};

            if (selectedGame === 'bangers') {
                // R√©cup√®re les options de Bangers
                options = {
                    mapId: document.getElementById('map-select').value,
                    maxScore: document.getElementById('score-input').value,
                    runTime: document.getElementById('time-input').value,
                    gameMode: document.getElementById('mode-select').value,
                    allowedItems: selectedItems
                };
            } else if (selectedGame === 'liars') {
                // R√©cup√®re les options de Liars
                options = {
                    deckSize: document.getElementById('liars-deck-size').value
                };
            }

            // Envoie au serveur
            socket.emit('hub_launchGame', { gameId: selectedGame, options: options });
        }
        
        // Redirections et Erreurs
        socket.on('redirectGame', (d) => window.location.href = d.url);
        socket.on('forceRedirect', (u) => window.location.href = u);
        socket.on('errorMsg', (m) => alert(m));

    </script>
</body>
</html>